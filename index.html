<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fashion Scout Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Updated Styles for a Boutique/Wardrobe Aesthetic */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fcfcfc; 
        }
        .chat-container { 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 30px; 
            background: #ffffff; 
            border-radius: 20px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); 
            border: 1px solid #e0e0e0; 
        }
        .message { 
            padding: 12px 18px; 
            margin-bottom: 15px; 
            border-radius: 18px; 
            max-width: 80%; 
            font-size: 0.95rem;
        }
        .user-message { 
            background-color: #e6f7ff; 
            margin-left: auto; 
            text-align: right; 
        }
        .assistant-message { 
            background-color: #fff8e1; 
            border: 1px solid #f9e79f; 
            text-align: left; 
        }
        /* Recommendation Cards */
        .recommendation-card { 
            border: 2px solid #2563eb; 
            border-left: 5px solid #2563eb; 
            transition: all 0.3s ease; 
            background-color: #f7f9fd; 
        }
        .recommendation-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #2563eb; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 2s linear infinite; 
            display: inline-block; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="chat-container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            <span class="text-blue-600">ðŸ‘—</span> AI Fashion Scout Chatbot
        </h1>
        <p class="text-center text-gray-500 mb-8">Let our CrewAI agents conduct a multi-step search for you.</p>
        
        <!-- Chat History -->
        <div id="chat-history" class="h-[400px] overflow-y-auto mb-6 p-4 border border-gray-200 rounded-xl bg-gray-50">
            <!-- Initial Message will be injected by JavaScript -->
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="flex gap-4">
            <input type="text" id="user-query" placeholder="Type your response here..." 
                   class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500" required>
            <button type="submit" id="submit-button" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200 shadow-lg disabled:bg-gray-400">
                Send
            </button>
        </form>

        <!-- Loading & Status Message -->
        <div id="status-message" class="mt-4 text-center text-sm text-gray-600 hidden">
            <div class="loader mr-2"></div>
            Searching the web with CrewAI... This may take up to a minute as agents collaborate.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatHistory = document.getElementById('chat-history');
            const chatForm = document.getElementById('chat-form');
            const userQueryInput = document.getElementById('user-query');
            const submitButton = document.getElementById('submit-button');
            const statusMessage = document.getElementById('status-message');
            
            // --- Conversational State Machine Setup ---
            const STATES = {
                INIT: 'INIT',
                AWAITING_STYLE: 'AWAITING_STYLE',
                AWAITING_BUDGET: 'AWAITING_BUDGET',
                AWAITING_DETAILS: 'AWAITING_DETAILS',
                READY_TO_SEARCH: 'READY_TO_SEARCH',
                SEARCHING: 'SEARCHING'
            };

            let chatState = STATES.INIT;
            let queryDetails = {
                style: '',
                budget: '',
                details: ''
            };
            
            // Configuration
            // NOTE: REPLACE 'YOUR_RENDER_URL' WITH YOUR ACTUAL LIVE DOMAIN (e.g., https://ai-fashion-scout-xyz.onrender.com)
            const API_ENDPOINT = 'YOUR_RENDER_URL/recommend_outfit';
            const IS_LIVE_DEPLOYED = true; // CHANGED to TRUE to use the live API!

            // --- Utility Functions ---

            function addMessage(sender, text, recommendations = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.innerHTML = `<p class="font-medium">${text}</p>`;

                if (recommendations.length > 0) {
                    const recsContainer = document.createElement('div');
                    recsContainer.className = 'mt-4 space-y-3';
                    
                    recommendations.forEach((item, index) => {
                        const card = document.createElement('div');
                        card.className = 'recommendation-card p-4 rounded-xl bg-white shadow-md'; 
                        card.innerHTML = `
                            <p class="text-xs font-semibold text-blue-600 mb-1">RECOMMENDATION #${index + 1}</p>
                            <h3 class="font-bold text-gray-800">${item.title}</h3>
                            <p class="text-lg font-mono text-gray-900 mt-1">${item.price}</p>
                            <p class="text-sm text-gray-600 mt-2">Source: ${item.source}</p>
                            <a href="${item.url}" target="_blank" 
                               class="inline-block mt-3 text-sm text-blue-600 hover:text-blue-800 font-medium">
                                View Product &rarr;
                            </a>
                        `;
                        recsContainer.appendChild(card);
                    });
                    messageDiv.appendChild(recsContainer);
                }
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            function assistantResponse(text) {
                addMessage('assistant', text);
            }
            
            // --- Conversational Logic ---

            function startConversation() {
                assistantResponse("Hello! I'm your AI Fashion Scout. I'm doing well, thank you for asking! Let's find you the perfect look.");
                setTimeout(() => {
                    assistantResponse("To start, what kind of style or item are you looking for? (e.g., 'a formal dress', 'casual pants', 'summer blouse')");
                    chatState = STATES.AWAITING_STYLE;
                }, 1000);
            }

            function handleConversation(input) {
                switch (chatState) {
                    case STATES.AWAITING_STYLE:
                        queryDetails.style = input;
                        assistantResponse(`Got it! We are looking for: **${input}**. Now, what is your budget for this item? (e.g., 'under $150', 'around $75')`);
                        chatState = STATES.AWAITING_BUDGET;
                        break;

                    case STATES.AWAITING_BUDGET:
                        queryDetails.budget = input;
                        assistantResponse(`Understood! We'll keep the price around **${input}**. Finally, please tell me about the color, material, or any specific details. (e.g., 'black floral, midi length, silk', or just 'blue')`);
                        chatState = STATES.AWAITING_DETAILS;
                        break;

                    case STATES.AWAITING_DETAILS:
                        queryDetails.details = input;
                        
                        const finalQuery = `${queryDetails.details}, ${queryDetails.style}, ${queryDetails.budget}`;

                        assistantResponse(`Perfect! I have all the details. I will now ask my CrewAI agents to search the web for the best match: **${finalQuery}**`);
                        
                        chatState = STATES.READY_TO_SEARCH;
                        // Immediately trigger the search now that we have the full query
                        triggerCrewAISearch(finalQuery);
                        break;
                        
                    case STATES.READY_TO_SEARCH:
                    case STATES.SEARCHING:
                        assistantResponse("I am already working on your request. Please wait while the agents collaborate and find the perfect outfit!");
                        break;
                    
                    default:
                        assistantResponse("Please refresh to start a new consultation.");
                        break;
                }
            }
            
            // MOCK API FUNCTION (Removed since IS_LIVE_DEPLOYED is TRUE)

            // --- CrewAI Search Trigger ---
            async function triggerCrewAISearch(query) {
                chatState = STATES.SEARCHING;
                submitButton.disabled = true;
                userQueryInput.disabled = true;

                try {
                    let result;
                    if (!IS_LIVE_DEPLOYED) {
                        // This branch is now effectively unreachable as IS_LIVE_DEPLOYED is true
                        console.error("Should be calling live API, but IS_LIVE_DEPLOYED is false.");
                        return;
                    } else {
                        // Use actual deployed FastAPI endpoint
                        statusMessage.classList.remove('hidden');
                        
                        // Fetch request with exponential backoff for robustness
                        const maxRetries = 5;
                        let delay = 1000;
                        let response = null;

                        for (let i = 0; i < maxRetries; i++) {
                            try {
                                response = await fetch(API_ENDPOINT, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ query: query })
                                });
                                if (response.ok) break; 
                            } catch (error) {
                                // Log the error internally but don't show to user yet
                                console.error(`Fetch attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                            }
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        }
                        
                        if (!response || !response.ok) {
                            throw new Error(`Failed to connect to the backend API after ${maxRetries} attempts.`);
                        }

                        result = await response.json();
                    }

                    // Display final structured recommendation
                    addMessage('assistant', result.summary, result.recommendations);
                    assistantResponse("I have finished the search! If you'd like to find another outfit, please refresh the page to start a new consultation.");
                    
                } catch (error) {
                    console.error('Error during CrewAI execution:', error);
                    addMessage('assistant', `âš ï¸ Sorry, the search failed: ${error.message}. Please check your deployed API status, your **SERPER_API_KEY** on Render, and refresh to try again.`);
                } finally {
                    statusMessage.classList.add('hidden');
                }
            }


            // Handle form submission (drives the conversation)
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = userQueryInput.value.trim();
                if (!input || chatState === STATES.SEARCHING) return;

                // 1. Display user message
                addMessage('user', input);
                userQueryInput.value = '';

                // 2. Handle conversation turn
                handleConversation(input);
            });
            
            // Start the chat!
            startConversation();
        });
    </script>
</body>
</html>
